# pick distinct eligible batches (batchId, batchNumber, product, bankCode)
sql.batch.distinct=SELECT DISTINCT pbm.SEQ_BATCH_ID AS batchId, pbm.BATCH_NUMBER AS batchNumber, SUBSTR(pbm.REQUEST_MESSAGE_ID,4,3) AS product, SUBSTR(pbm.REQUEST_MESSAGE_ID,1,3) AS bankCode FROM PAYMENT_BATCH_MASTER pbm JOIN PAYMENT_DEBIT_MASTER pdm ON pdm.BATCH_ID = pbm.SEQ_BATCH_ID JOIN PAYMENT_CREDIT_MASTER pcm ON pcm.SEQ_BATCH_ID = pbm.SEQ_BATCH_ID WHERE pcm.PAYMENT_INITI_REQ_ID IS NULL AND pbm.REQUEST_MESSAGE_ID NOT LIKE '056EAT%' AND pdm.SYNC_STATUS = 'S' AND pcm.SYNC_STATUS = 'S' AND ( (pdm.DEBIT_STATUS = 'PI' AND TRIM(pcm.CREDIT_STATUS) IN ('I','A','R','X') AND pcm.PMT_MTD <> 'NACH') OR (pdm.DEBIT_STATUS = 'PI' AND TRIM(pcm.CREDIT_STATUS) IN ('A','R') AND pcm.PMT_MTD = 'NACH') OR pdm.DEBIT_STATUS IN ('BR','EX') )

# debit row (IFSC, acct no, ts, debitAmt, cpsmsDebitTran, authMode) by batch
sql.debit.byBatch=SELECT pdm.AGENCY_IFSC, pdm.AGENCY_ACCOUNT_NUMBER, TO_CHAR(NVL(pdm.MODIFIED_DATE, SYSDATE),'yyyymmddHH24miss') AS ts, TO_CHAR(pdm.DEBIT_AMOUNT) AS debitAmt, pdm.CPSMS_DEBIT_TRAN_ID, NVL(pbm.AUTHMOD,'NA') AS authMode FROM PAYMENT_DEBIT_MASTER pdm JOIN PAYMENT_BATCH_MASTER pbm ON pbm.SEQ_BATCH_ID = pdm.BATCH_ID WHERE pdm.BATCH_ID = :batchId FETCH FIRST 1 ROWS ONLY

# credit rows (strict column set used by XmlWriter) by batch
sql.credit.byBatch=SELECT pcm.SEQ_CREDIT_ID, pcm.CPSMS_CREDIT_TRAN AS C2006, pcm.CREDIT_IFSC AS C5569, CASE WHEN pcm.PMT_MTD = 'APBS' THEN NVL(NULLIF(pcm.CREDIT_ACCOUNT_NUMBER,''),'00000') ELSE pcm.CREDIT_ACCOUNT_NUMBER END AS C6061, TO_CHAR(pcm.CREDIT_UID) AS UID, CASE WHEN pcm.PMT_MTD = 'APBS' THEN (CASE WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 9 THEN SUBSTR(pcm.CREDIT_BANK_IIN,4,6) WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 6 THEN pcm.CREDIT_BANK_IIN WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 0 AND pcm.CREDIT_IFSC LIKE 'SBIN00%' THEN '508548' WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 0 AND pcm.CREDIT_IFSC LIKE 'BKDN%' THEN '508547' WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 0 AND pcm.CREDIT_IFSC LIKE 'DCBL%' THEN '607290' WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 0 AND pcm.CREDIT_IFSC LIKE 'HDFC%' THEN '607152' ELSE '000000' END) ELSE 'NA' END AS BankIIN, pcm.CREDIT_ACCOUNT_NAME AS C6081, NVL(pcm.INITIATING_UTR, pcm.TRAN_ID_FT) AS C2020, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'yyyymmddHH24miss') AS C3501, TO_CHAR(pcm.CREDIT_AMOUNT) AS C4038, NVL(pcm.C6366_INI, ' ') AS C6366, CASE WHEN EXISTS (SELECT 1 FROM PAYMENT_DEBIT_MASTER pdm WHERE pdm.SEQ_DEBIT_ID = pcm.DEBIT_ID AND pdm.DEBIT_STATUS = 'PI') AND pcm.CREDIT_STATUS = 'A' THEN 'SUCC' WHEN EXISTS (SELECT 1 FROM PAYMENT_DEBIT_MASTER pdm WHERE pdm.SEQ_DEBIT_ID = pcm.DEBIT_ID AND pdm.DEBIT_STATUS IN ('BR','EX')) THEN 'DBFL' WHEN TRIM(pcm.CREDIT_STATUS) = 'I' AND pcm.PMT_MTD = 'APBS' THEN 'INIT' WHEN TRIM(pcm.CREDIT_STATUS) = 'I' AND pcm.PMT_MTD NOT IN ('APBS','NACH') THEN 'SUCC' ELSE NVL(pcm.C6346_INI,'INIT') END AS C6346, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'yyyymmddHH24miss') AS C3380, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'yyyymmddHH24miss') AS C3375, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'yyyymmddHH24miss') AS C3381, CASE pcm.PMT_MTD WHEN 'N' THEN 'NEFT' WHEN 'T' THEN 'ICBS' WHEN 'R' THEN 'RTGS' ELSE pcm.PMT_MTD END AS PmtRoute FROM PAYMENT_CREDIT_MASTER pcm WHERE pcm.SEQ_BATCH_ID = :batchId AND pcm.SYNC_STATUS = 'S'

# (optional) update after successful file write
sql.update.markInitiByBatch=UPDATE PAYMENT_CREDIT_MASTER SET PAYMENT_INITI_REQ_ID = :msgId, MODIFIED_DATE = SYSTIMESTAMP WHERE SEQ_BATCH_ID = :batchId AND (PAYMENT_INITI_REQ_ID IS NULL OR LENGTH(TRIM(PAYMENT_INITI_REQ_ID)) = 0)
