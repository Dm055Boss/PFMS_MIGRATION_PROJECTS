########################
# File paths / settings
########################

# Where to drop generated Success Ack XMLs
success-ack.output-dir=C:\\PFMS_MIG\\CPSMS\\PAYSUCC\\

# Counter properties file (same idea as old PAYSUCCOUNTER.properties)
success-ack.counter-file=C:\\PFMS_MIG\\CPSMS\\PAYSUCC\\PAYINICNTR.properties

# Bank name
success-ack.bank-name=IDBI BANK

# Optional fixed bank code (if empty, derived from REQUEST_MESSAGE_ID)
success-ack.bank-code=

# Directory where CPSMS puts ACK response XMLs
success-ack.output-dir=C:\\PFMS_MIG\\CPSMS\\PAYSUCC\\


########################
# SQL queries
########################

# Cron schedule
success-ack.job.cron=0 */5 * * * ?

# 1) SELECT BATCHES
# =======================
success.select-batches=SELECT DISTINCT b.SEQ_BATCH_ID AS batchId, b.BATCH_NUMBER AS batchNumber, b.PAYMENT_PROD AS paymentProd, SUBSTR(b.REQUEST_MESSAGE_ID,1,3) AS bankCode, b.RECORD_COUNT AS rc FROM PAYMENT_BATCH_MASTER b JOIN PAYMENT_DEBIT_MASTER d ON d.BATCH_ID = b.SEQ_BATCH_ID JOIN PAYMENT_CREDIT_MASTER c ON c.DEBIT_ID = d.SEQ_DEBIT_ID JOIN PAYMENT_REGEN_REQUESTS r ON r.SEQ_CREDIT_ID = c.SEQ_CREDIT_ID WHERE r.FILETYPE = 'SUC' AND r.MAKER_ID IS NOT NULL AND r.CHECKER_ID IS NOT NULL AND r.NEW_SUCCESS_ID IS NULL AND b.REQUEST_MESSAGE_ID NOT LIKE '691EAT%' AND c.SYNC_STATUS = 'S' AND d.SYNC_STATUS = 'S' AND d.DEBIT_STATUS = 'PI' AND ((c.CREDIT_STATUS = 'I' AND c.PMT_MTD IN ('N','T')) OR c.CREDIT_STATUS = 'A')
# =======================
# 2) SELECT CREDITS
# =======================
success.select-credits=SELECT c.SEQ_CREDIT_ID AS id, r.BATCH_NUMBER AS batchNumber, r.PAYMENT_PROD AS paymentProd, SUBSTR(r.REQUEST_MESSAGE_ID,1,3) AS bankCode, c.CPSMS_CREDIT_TRAN AS cpsmsCreditTran, c.CREDIT_IFSC AS creditIfsc, r.CREDIT_ACCOUNT_NUMBER AS creditAccountNumber, c.CREDIT_BANK_IIN AS creditBankIin, c.CREDIT_UID AS creditUid, c.CREDIT_ACCOUNT_NAME AS creditAccountName, c.CREDIT_AMOUNT AS creditAmount, c.CREDIT_STATUS AS creditStatus, r.PMT_MTD AS pmtMtd, c.TRAN_DATE_FT AS tranDateFt, r.TRAN_ID_FT AS tranIdFt, r.INITIATING_UTR AS initiatingUtr, d.DEBIT_TRAN_ID AS debitTranId FROM PAYMENT_CREDIT_MASTER c JOIN PAYMENT_DEBIT_MASTER d ON d.SEQ_DEBIT_ID = c.DEBIT_ID JOIN PAYMENT_BATCH_MASTER b ON b.SEQ_BATCH_ID = c.SEQ_BATCH_ID JOIN PAYMENT_REGEN_REQUESTS r ON r.SEQ_CREDIT_ID = c.SEQ_CREDIT_ID WHERE b.SEQ_BATCH_ID = :batchId AND r.FILETYPE = 'SUC' AND r.MAKER_ID IS NOT NULL AND r.CHECKER_ID IS NOT NULL AND r.NEW_SUCCESS_ID IS NULL AND c.SYNC_STATUS = 'S'
# =======================
# 3) UPDATE CREDITS
# =======================
success.update-credits=UPDATE PAYMENT_REGEN_REQUESTS r SET NEW_SUCCESS_ID = :msgId WHERE r.FILETYPE = 'SUC' AND r.MAKER_ID IS NOT NULL AND r.CHECKER_ID IS NOT NULL AND r.SEQ_CREDIT_ID IN (SELECT c.SEQ_CREDIT_ID FROM PAYMENT_CREDIT_MASTER c WHERE c.CPSMS_CREDIT_TRAN IN (:creditTrans))
# =======================
# 4) DEBIT STATUS FOR BATCH
# =======================
success.debit-status-for-batch=SELECT DISTINCT DEBIT_STATUS FROM PAYMENT_DEBIT_MASTER WHERE BATCH_ID = :batchId

# =======================
# 5) COUNT AUDIT
# =======================
success.count-audit-for-batch=SELECT COUNT(1) FROM TBL_CPSMS_AUDIT_TABLE WHERE REQUESTMESSAGEID LIKE :reqMsgPrefix AND BATCHNUMBER = :batchNumber

# =======================
# 6) FIRST AUDIT INSERT
# =======================
success.insert-audit-first=INSERT INTO TBL_CPSMS_AUDIT_TABLE (ID, REQUESTMESSAGEID, BATCHNUMBER, DATE_TIME, BATCHSTATUS, REMARKS1, REMARKS2) VALUES (NVL((SELECT MAX(ID)+1 FROM TBL_CPSMS_AUDIT_TABLE),1), :reqMsgId, :batchNumber, SYSDATE, :batchStatus, 'SUC', 'Send Payment Success File')

# =======================
# 7) RESEND AUDIT INSERT
# =======================
success.insert-audit-resend=INSERT INTO TBL_CPSMS_AUDIT_TABLE (ID, REQUESTMESSAGEID, BATCHNUMBER, DATE_TIME, BATCHSTATUS, REMARKS1, REMARKS2) VALUES (NVL((SELECT MAX(ID)+1 FROM TBL_CPSMS_AUDIT_TABLE),1), :reqMsgId, :batchNumber, SYSDATE, :batchStatus, 'SUC', :remarks2)