########################
# File paths / settings
########################

# Where to drop generated Success Ack XMLs
success-ack.output-dir=C:\\PFMS_MIG\\CPSMS\\PAYSUCC\\

# Counter properties file (same idea as old PAYSUCCOUNTER.properties)
success-ack.counter-file=C:\\PFMS_MIG\\CPSMS\\PAYSUCC\\PAYINICNTR.properties

# Bank name
success-ack.bank-name=IDBI BANK

# Optional fixed bank code (if empty, derived from REQUEST_MESSAGE_ID)
success-ack.bank-code=

# Directory where CPSMS puts ACK response XMLs
success-ack.output-dir=C:\\PFMS_MIG\\CPSMS\\PAYSUCC\\


########################
# SQL queries
########################

# Cron schedule
success-ack.job.cron=0 */0.30 * * * ?

# SQL to fetch eligible batches
success-ack.sql.select-batches=
SELECT DISTINCT 
   b.SEQ_BATCH_ID as batchId,
   b.BATCH_NUMBER as batchNumber,
   b.PAYMENT_PROD as paymentProd,
   SUBSTR(b.REQUEST_MESSAGE_ID,1,3) as bankCode
FROM PAYMENT_BATCH_MASTER b
JOIN PAYMENT_DEBIT_MASTER d ON d.BATCH_ID = b.SEQ_BATCH_ID
JOIN PAYMENT_CREDIT_MASTER c ON c.DEBIT_ID = d.SEQ_DEBIT_ID
WHERE c.PAYMENT_SUCCESS_REQ_ID IS NULL
  AND b.REQUEST_MESSAGE_ID NOT LIKE '691EAT%'
  AND c.SYNC_STATUS='S'
  AND d.SYNC_STATUS='S'
  AND d.DEBIT_STATUS='PI'
  AND (
       (c.CREDIT_STATUS='I' AND c.PMT_MTD IN ('N','T'))
       OR c.CREDIT_STATUS='A'
      )

# SQL to fetch eligible credits
success-ack.sql.select-credits=
SELECT 
   c.SEQ_CREDIT_ID as id,
   b.BATCH_NUMBER as batchNumber,
   b.PAYMENT_PROD as paymentProd,
   SUBSTR(b.REQUEST_MESSAGE_ID,1,3) as bankCode,
   c.CPSMS_CREDIT_TRAN as cpsmsCreditTran,
   c.CREDIT_IFSC as creditIfsc,
   c.CREDIT_ACCOUNT_NUMBER as creditAccountNumber,
   c.CREDIT_BANK_IIN as creditBankIin,
   c.CREDIT_UID as creditUid,
   c.CREDIT_ACCOUNT_NAME as creditAccountName,
   c.CREDIT_AMOUNT as creditAmount,
   c.CREDIT_STATUS as creditStatus,
   c.PMT_MTD as pmtMtd,
   c.TRAN_DATE_FT as tranDateFt,
   c.TRAN_ID_FT as tranIdFt,
   c.INITIATING_UTR as initiatingUtr,
   d.DEBIT_TRAN_ID as debitTranId
FROM PAYMENT_CREDIT_MASTER c
JOIN PAYMENT_DEBIT_MASTER d ON d.SEQ_DEBIT_ID = c.DEBIT_ID
JOIN PAYMENT_BATCH_MASTER b ON b.SEQ_BATCH_ID = c.SEQ_BATCH_ID
WHERE b.SEQ_BATCH_ID = :batchId
  AND c.PAYMENT_SUCCESS_REQ_ID IS NULL
  AND c.SYNC_STATUS='S'

# Update credit with Message ID
success-ack.sql.update-credits=
UPDATE PAYMENT_CREDIT_MASTER
SET PAYMENT_SUCCESS_REQ_ID = :msgId
WHERE CPSMS_CREDIT_TRAN IN (:creditTrans)

# Fetch DEBIT_STATUS for audit
success-ack.sql.debit-status-for-batch=
SELECT DISTINCT DEBIT_STATUS
FROM PAYMENT_DEBIT_MASTER
WHERE BATCH_ID = :batchId

# Audit count
success-ack.sql.count-audit-for-batch=
SELECT COUNT(1)
FROM TBL_CPSMS_AUDIT_TABLE
WHERE REQUESTMESSAGEID LIKE :reqMsgPrefix
  AND BATCHNUMBER = :batchNumber

# Insert first audit entry
success-ack.sql.insert-audit-first=
INSERT INTO TBL_CPSMS_AUDIT_TABLE
(ID, REQUESTMESSAGEID, BATCHNUMBER, DATE_TIME, BATCHSTATUS, REMARKS1, REMARKS2)
VALUES (
   NVL((SELECT MAX(ID)+1 FROM TBL_CPSMS_AUDIT_TABLE),1),
   :reqMsgId, :batchNumber, SYSDATE, :batchStatus,
   'SUC', 'Send Payment Success File'
)

# Insert resend audit entry
success-ack.sql.insert-audit-resend=
INSERT INTO TBL_CPSMS_AUDIT_TABLE
(ID, REQUESTMESSAGEID, BATCHNUMBER, DATE_TIME, BATCHSTATUS, REMARKS1, REMARKS2)
VALUES (
   NVL((SELECT MAX(ID)+1 FROM TBL_CPSMS_AUDIT_TABLE),1),
   :reqMsgId, :batchNumber, SYSDATE, :batchStatus,
   'SUC', :remarks2
)
