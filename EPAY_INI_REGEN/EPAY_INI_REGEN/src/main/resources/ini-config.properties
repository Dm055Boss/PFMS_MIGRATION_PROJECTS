# pick distinct eligible batches (batchId, batchNumber, product, bankCode)
# sql.batch.distinct=SELECT DISTINCT pbm.SEQ_BATCH_ID AS batchId, pbm.BATCH_NUMBER AS batchNumber, SUBSTR(pbm.REQUEST_MESSAGE_ID,4,3) AS product, SUBSTR(pbm.REQUEST_MESSAGE_ID,1,3) AS bankCode FROM PAYMENT_BATCH_MASTER pbm JOIN PAYMENT_DEBIT_MASTER pdm ON pdm.BATCH_ID = pbm.SEQ_BATCH_ID JOIN PAYMENT_CREDIT_MASTER pcm ON pcm.SEQ_BATCH_ID = pbm.SEQ_BATCH_ID WHERE pcm.PAYMENT_INITI_REQ_ID IS NULL AND pbm.REQUEST_MESSAGE_ID NOT LIKE '056EAT%' AND pdm.SYNC_STATUS = 'S' AND pcm.SYNC_STATUS = 'S' AND ( (pdm.DEBIT_STATUS = 'PI' AND TRIM(pcm.CREDIT_STATUS) IN ('I','A','R','X') AND pcm.PMT_MTD <> 'NACH') OR (pdm.DEBIT_STATUS = 'PI' AND TRIM(pcm.CREDIT_STATUS) IN ('A','R') AND pcm.PMT_MTD = 'NACH') OR pdm.DEBIT_STATUS IN ('BR','EX') )
sql.batch.distinct=SELECT DISTINCT pbm.SEQ_BATCH_ID AS batchId, r.BATCH_NUMBER AS batchNumber, SUBSTR(r.REQUEST_MESSAGE_ID,4,3) AS product, SUBSTR(r.REQUEST_MESSAGE_ID,1,3) AS bankCode FROM PAYMENT_BATCH_MASTER pbm JOIN PAYMENT_DEBIT_MASTER pdm ON pdm.BATCH_ID = pbm.SEQ_BATCH_ID JOIN PAYMENT_CREDIT_MASTER pcm ON pcm.SEQ_BATCH_ID = pbm.SEQ_BATCH_ID JOIN PAYMENT_REGEN_REQUESTS r ON r.SEQ_CREDIT_ID = pcm.SEQ_CREDIT_ID WHERE r.FILETYPE = 'INI' AND r.MAKER_ID IS NOT NULL AND r.CHECKER_ID IS NOT NULL AND r.NEW_INI_ID IS NULL AND r.REQUEST_MESSAGE_ID NOT LIKE '056EAT%' AND pdm.SYNC_STATUS = 'S' AND pcm.SYNC_STATUS = 'S' AND ((pdm.DEBIT_STATUS = 'PI' AND TRIM(pcm.CREDIT_STATUS) IN ('I','A','R','X') AND pcm.PMT_MTD <> 'NACH') OR (pdm.DEBIT_STATUS = 'PI' AND TRIM(pcm.CREDIT_STATUS) IN ('A','R') AND pcm.PMT_MTD = 'NACH') OR pdm.DEBIT_STATUS IN ('BR','EX'))


# debit row (IFSC, acct no, ts, debitAmt, cpsmsDebitTran, authMode) by batch
# sql.debit.byBatch=SELECT * FROM ( SELECT NVL(pdm.AGENCY_IFSC,'') AGENCYIFSC, NVL(pdm.AGENCY_ACCOUNT_NUMBER,'') AGENCYACCOUNTNUMBER, NVL(TO_CHAR(pdm.DEBIT_AMOUNT),'0') DEBITAMOUNT, NVL(pdm.CPSMS_DEBIT_TRAN_ID,'') CPSMSDEBITTRANID, NVL(NVL(pdm.DEBIT_TRAN_ID,pdm.DEBIT_STAN),'') INIT_UTR, TO_CHAR(NVL(pdm.DEBIT_TRAN_DATE, pbm.MODIFIED_DATE), 'YYYYMMDDHH24MISS') TS, CASE WHEN pdm.DEBIT_STATUS='BR' THEN 'D016' WHEN pdm.DEBIT_STATUS='EX' THEN 'D032' WHEN EXISTS ( SELECT 1 FROM dual WHERE (SELECT COUNT(*) FROM PAYMENT_CREDIT_MASTER p1 WHERE p1.SEQ_BATCH_ID=:batchId AND NVL(p1.PMT_MTD,'N')='NACH' AND p1.SYNC_STATUS='S' AND p1.PAYMENT_INITI_REQ_ID IS NULL) > 0 AND (SELECT COUNT(*) FROM PAYMENT_CREDIT_MASTER p2 JOIN PAYMENT_DEBIT_MASTER d2 ON d2.SEQ_DEBIT_ID=p2.DEBIT_ID WHERE p2.SEQ_BATCH_ID=:batchId AND NVL(p2.PMT_MTD,'N')='NACH' AND TRIM(p2.CREDIT_STATUS)='R' AND d2.DEBIT_STATUS='PI' AND p2.SYNC_STATUS='S' AND p2.PAYMENT_INITI_REQ_ID IS NULL) = (SELECT COUNT(*) FROM PAYMENT_CREDIT_MASTER p3 WHERE p3.SEQ_BATCH_ID=:batchId AND NVL(p3.PMT_MTD,'N')='NACH' AND p3.SYNC_STATUS='S' AND p3.PAYMENT_INITI_REQ_ID IS NULL) ) THEN 'D021' WHEN NVL(pdm.DEBIT_STATUS,'NA')='PI' AND EXISTS (SELECT 1 FROM PAYMENT_CREDIT_MASTER pc WHERE pc.SEQ_BATCH_ID=:batchId AND TRIM(pc.CREDIT_STATUS)='R' AND NVL(pc.PMT_MTD,'N')<>'NACH' AND pc.SYNC_STATUS='S' AND pc.PAYMENT_INITI_REQ_ID IS NULL) AND pdm.DEBIT_TRAN_ID IS NULL THEN CASE WHEN pdm.REMARKS IN ('INSUFFICIENT FUNDS','Insufficient funds','INSUFFICIENT AMOUNT IN AGENCY ACCT') THEN 'D012' WHEN pdm.REMARKS IN ('AGENCY ACCOUNT CLOSED') THEN 'D003' WHEN pdm.REMARKS IN ('AGENCY ACCOUNT FREEZE','Freeze on agency account') THEN 'D005' WHEN pdm.REMARKS IN ('AGENCY WORNG IFSC') THEN 'D036' WHEN pdm.REMARKS IN ('THE WITHDRAWAL AMOUNT CANNOT EXCEED THE ACCOUNT','Withdrawal limit exceeded') THEN 'D014' ELSE 'D021' END ELSE 'SUCC' END AS C6346, CASE WHEN pbm.REQUEST_MESSAGE_ID LIKE '691EPA%' AND pbm.AUTHMOD IS NULL THEN 'BRNC' WHEN pbm.REQUEST_MESSAGE_ID LIKE '691EPA%' AND pbm.AUTHMOD IS NOT NULL THEN 'CINB' ELSE 'NA' END AS AUTH_MODE FROM PAYMENT_DEBIT_MASTER pdm JOIN PAYMENT_BATCH_MASTER pbm ON pbm.SEQ_BATCH_ID=pdm.BATCH_ID WHERE pdm.BATCH_ID=:batchId AND pdm.SYNC_STATUS='S' ORDER BY NVL(pdm.DEBIT_TRAN_DATE, pbm.MODIFIED_DATE) DESC NULLS LAST ) WHERE ROWNUM=1
sql.debit.byBatch=SELECT * FROM ( SELECT NVL(pdm.AGENCY_IFSC,'') AGENCYIFSC, NVL(pdm.AGENCY_ACCOUNT_NUMBER,'') AGENCYACCOUNTNUMBER, NVL(TO_CHAR(pdm.DEBIT_AMOUNT),'0') DEBITAMOUNT, NVL(pdm.CPSMS_DEBIT_TRAN_ID,'') CPSMSDEBITTRANID, NVL(NVL(pdm.DEBIT_TRAN_ID,pdm.DEBIT_STAN),'') INIT_UTR, TO_CHAR(NVL(pdm.DEBIT_TRAN_DATE, pbm.MODIFIED_DATE), 'YYYYMMDDHH24MISS') TS, CASE WHEN pdm.DEBIT_STATUS='BR' THEN 'D016' WHEN pdm.DEBIT_STATUS='EX' THEN 'D032' WHEN EXISTS ( SELECT 1 FROM dual WHERE (SELECT COUNT(*) FROM PAYMENT_CREDIT_MASTER p1 JOIN PAYMENT_REGEN_REQUESTS r1 ON r1.SEQ_CREDIT_ID=p1.SEQ_CREDIT_ID WHERE p1.SEQ_BATCH_ID=:batchId AND NVL(p1.PMT_MTD,'N')='NACH' AND p1.SYNC_STATUS='S' AND r1.FILETYPE='INI' AND r1.MAKER_ID IS NOT NULL AND r1.CHECKER_ID IS NOT NULL AND r1.NEW_INI_ID IS NULL) > 0 AND (SELECT COUNT(*) FROM PAYMENT_CREDIT_MASTER p2 JOIN PAYMENT_DEBIT_MASTER d2 ON d2.SEQ_DEBIT_ID=p2.DEBIT_ID JOIN PAYMENT_REGEN_REQUESTS r2 ON r2.SEQ_CREDIT_ID=p2.SEQ_CREDIT_ID WHERE p2.SEQ_BATCH_ID=:batchId AND NVL(p2.PMT_MTD,'N')='NACH' AND TRIM(p2.CREDIT_STATUS)='R' AND d2.DEBIT_STATUS='PI' AND p2.SYNC_STATUS='S' AND r2.FILETYPE='INI' AND r2.MAKER_ID IS NOT NULL AND r2.CHECKER_ID IS NOT NULL AND r2.NEW_INI_ID IS NULL) = (SELECT COUNT(*) FROM PAYMENT_CREDIT_MASTER p3 JOIN PAYMENT_REGEN_REQUESTS r3 ON r3.SEQ_CREDIT_ID=p3.SEQ_CREDIT_ID WHERE p3.SEQ_BATCH_ID=:batchId AND NVL(p3.PMT_MTD,'N')='NACH' AND p3.SYNC_STATUS='S' AND r3.FILETYPE='INI' AND r3.MAKER_ID IS NOT NULL AND r3.CHECKER_ID IS NOT NULL AND r3.NEW_INI_ID IS NULL) ) THEN 'D021' WHEN NVL(pdm.DEBIT_STATUS,'NA')='PI' AND EXISTS (SELECT 1 FROM PAYMENT_CREDIT_MASTER pc JOIN PAYMENT_REGEN_REQUESTS r4 ON r4.SEQ_CREDIT_ID=pc.SEQ_CREDIT_ID WHERE pc.SEQ_BATCH_ID=:batchId AND TRIM(pc.CREDIT_STATUS)='R' AND NVL(pc.PMT_MTD,'N')<>'NACH' AND pc.SYNC_STATUS='S' AND r4.FILETYPE='INI' AND r4.MAKER_ID IS NOT NULL AND r4.CHECKER_ID IS NOT NULL AND r4.NEW_INI_ID IS NULL) AND pdm.DEBIT_TRAN_ID IS NULL THEN CASE WHEN pdm.REMARKS IN ('INSUFFICIENT FUNDS','Insufficient funds','INSUFFICIENT AMOUNT IN AGENCY ACCT') THEN 'D012' WHEN pdm.REMARKS IN ('AGENCY ACCOUNT CLOSED') THEN 'D003' WHEN pdm.REMARKS IN ('AGENCY ACCOUNT FREEZE','Freeze on agency account') THEN 'D005' WHEN pdm.REMARKS IN ('AGENCY WORNG IFSC') THEN 'D036' WHEN pdm.REMARKS IN ('THE WITHDRAWAL AMOUNT CANNOT EXCEED THE ACCOUNT','Withdrawal limit exceeded') THEN 'D014' ELSE 'D021' END ELSE 'SUCC' END AS C6346, CASE WHEN pbm.REQUEST_MESSAGE_ID LIKE '691EPA%' AND pbm.AUTHMOD IS NULL THEN 'BRNC' WHEN pbm.REQUEST_MESSAGE_ID LIKE '691EPA%' AND pbm.AUTHMOD IS NOT NULL THEN 'CINB' ELSE 'NA' END AS AUTH_MODE FROM PAYMENT_DEBIT_MASTER pdm JOIN PAYMENT_BATCH_MASTER pbm ON pbm.SEQ_BATCH_ID=pdm.BATCH_ID WHERE pdm.BATCH_ID=:batchId AND pdm.SYNC_STATUS='S' ORDER BY NVL(pdm.DEBIT_TRAN_DATE, pbm.MODIFIED_DATE) DESC NULLS LAST ) WHERE ROWNUM=1

# credit rows (strict column set used by XmlWriter) by batch
# sql.credit.byBatch=SELECT pcm.SEQ_CREDIT_ID, pcm.CPSMS_CREDIT_TRAN AS C2006, pcm.CREDIT_IFSC AS C5569, CASE WHEN pcm.PMT_MTD = 'APBS' THEN NVL(NULLIF(pcm.CREDIT_ACCOUNT_NUMBER,''),'00000') ELSE pcm.CREDIT_ACCOUNT_NUMBER END AS C6061, TO_CHAR(pcm.CREDIT_UID) AS UID, CASE WHEN pcm.PMT_MTD = 'APBS' THEN (CASE WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 9 THEN SUBSTR(pcm.CREDIT_BANK_IIN,4,6) WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 6 THEN pcm.CREDIT_BANK_IIN WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 0 AND pcm.CREDIT_IFSC LIKE 'SBIN00%' THEN '508548' WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 0 AND pcm.CREDIT_IFSC LIKE 'BKDN%' THEN '508547' WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 0 AND pcm.CREDIT_IFSC LIKE 'DCBL%' THEN '607290' WHEN LENGTH(pcm.CREDIT_BANK_IIN) = 0 AND pcm.CREDIT_IFSC LIKE 'HDFC%' THEN '607152' ELSE '000000' END) ELSE 'NA' END AS BankIIN, pcm.CREDIT_ACCOUNT_NAME AS C6081, NVL(pcm.INITIATING_UTR, pcm.TRAN_ID_FT) AS C2020, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'yyyymmddHH24miss') AS C3501, TO_CHAR(pcm.CREDIT_AMOUNT) AS C4038, NVL(pcm.C6366_INI, ' ') AS C6366, CASE WHEN EXISTS (SELECT 1 FROM PAYMENT_DEBIT_MASTER pdm WHERE pdm.SEQ_DEBIT_ID = pcm.DEBIT_ID AND pdm.DEBIT_STATUS = 'PI') AND pcm.CREDIT_STATUS = 'A' THEN 'SUCC' WHEN EXISTS (SELECT 1 FROM PAYMENT_DEBIT_MASTER pdm WHERE pdm.SEQ_DEBIT_ID = pcm.DEBIT_ID AND pdm.DEBIT_STATUS IN ('BR','EX')) THEN 'DBFL' WHEN TRIM(pcm.CREDIT_STATUS) = 'I' AND pcm.PMT_MTD = 'APBS' THEN 'INIT' WHEN TRIM(pcm.CREDIT_STATUS) = 'I' AND pcm.PMT_MTD NOT IN ('APBS','NACH') THEN 'SUCC' ELSE NVL(pcm.C6346_INI,'INIT') END AS C6346, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'yyyymmddHH24miss') AS C3380, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'yyyymmddHH24miss') AS C3375, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'yyyymmddHH24miss') AS C3381, CASE pcm.PMT_MTD WHEN 'N' THEN 'NEFT' WHEN 'T' THEN 'ICBS' WHEN 'R' THEN 'RTGS' ELSE pcm.PMT_MTD END AS PmtRoute FROM PAYMENT_CREDIT_MASTER pcm WHERE pcm.SEQ_BATCH_ID = :batchId AND pcm.SYNC_STATUS = 'S'
sql.credit.byBatch=SELECT pcm.SEQ_CREDIT_ID AS SEQ_CREDIT_ID, NVL(pcm.CPSMS_CREDIT_TRAN,'') AS C2006, NVL(pcm.CREDIT_IFSC,'') AS C5569, CASE WHEN r.PMT_MTD='APBS' THEN NVL(NVL(TO_CHAR(pcm.CREDIT_UID), r.CREDIT_ACCOUNT_NUMBER),'00000') ELSE NVL(r.CREDIT_ACCOUNT_NUMBER,'') END AS C6061, NVL(TO_CHAR(pcm.CREDIT_UID),'') AS CUID, CASE WHEN r.PMT_MTD='APBS' THEN (CASE WHEN NVL(LENGTH(pcm.CREDIT_BANK_IIN),0)=9 THEN SUBSTR(pcm.CREDIT_BANK_IIN,4,6) WHEN NVL(LENGTH(pcm.CREDIT_BANK_IIN),0)=6 THEN pcm.CREDIT_BANK_IIN WHEN NVL(LENGTH(pcm.CREDIT_BANK_IIN),0)=0 AND pcm.CREDIT_IFSC LIKE 'SBIN00%' THEN '508548' WHEN NVL(LENGTH(pcm.CREDIT_BANK_IIN),0)=0 AND pcm.CREDIT_IFSC LIKE 'BKDN%' THEN '508547' WHEN NVL(LENGTH(pcm.CREDIT_BANK_IIN),0)=0 AND pcm.CREDIT_IFSC LIKE 'DCBL%' THEN '607290' WHEN NVL(LENGTH(pcm.CREDIT_BANK_IIN),0)=0 AND pcm.CREDIT_IFSC LIKE 'HDFC%' THEN '607152' ELSE '000000' END) ELSE 'NA' END AS BankIIN, NVL(pcm.CREDIT_ACCOUNT_NAME,'') AS C6081, NVL(r.INITIATING_UTR, r.TRAN_ID_FT) AS C2020, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'YYYYMMDDHH24MISS') AS C3501, TO_CHAR(NVL(pcm.CREDIT_AMOUNT,0)) AS C4038, NVL(r.C6366_INI, NVL(pcm.C6366_INI,' ')) AS C6366, CASE WHEN EXISTS (SELECT 1 FROM PAYMENT_DEBIT_MASTER pdm WHERE pdm.SEQ_DEBIT_ID=pcm.DEBIT_ID AND pdm.DEBIT_STATUS='PI') AND TRIM(pcm.CREDIT_STATUS)='A' THEN 'SUCC' WHEN EXISTS (SELECT 1 FROM PAYMENT_DEBIT_MASTER pdm WHERE pdm.SEQ_DEBIT_ID=pcm.DEBIT_ID AND pdm.DEBIT_STATUS IN ('BR','EX')) THEN 'DBFL' WHEN TRIM(pcm.CREDIT_STATUS)='I' AND r.PMT_MTD='APBS' THEN 'INIT' WHEN TRIM(pcm.CREDIT_STATUS)='I' AND r.PMT_MTD NOT IN ('APBS','NACH') THEN 'SUCC' ELSE NVL(r.C6346_INI, NVL(pcm.C6346_INI,'INIT')) END AS C6346, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'YYYYMMDDHH24MISS') AS C3380, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'YYYYMMDDHH24MISS') AS C3375, TO_CHAR(NVL(pcm.MODIFIED_DATE, SYSDATE),'YYYYMMDDHH24MISS') AS C3381, CASE r.PMT_MTD WHEN 'N' THEN 'NEFT' WHEN 'T' THEN 'ICBS' WHEN 'R' THEN 'RTGS' ELSE r.PMT_MTD END AS PMTROUTE FROM PAYMENT_CREDIT_MASTER pcm JOIN PAYMENT_REGEN_REQUESTS r ON r.SEQ_CREDIT_ID=pcm.SEQ_CREDIT_ID WHERE pcm.SEQ_BATCH_ID=:batchId AND pcm.SYNC_STATUS='S' AND r.FILETYPE='INI' AND r.MAKER_ID IS NOT NULL AND r.CHECKER_ID IS NOT NULL AND r.NEW_INI_ID IS NULL

#update after successful file write
sql.update.markInitiByBatch=UPDATE PAYMENT_REGEN_REQUESTS r SET NEW_INI_ID = :msgId WHERE r.SEQ_BATCH_ID = :batchId AND r.FILETYPE = 'INI' AND r.MAKER_ID IS NOT NULL AND r.CHECKER_ID IS NOT NULL AND r.NEW_INI_ID IS NULL
